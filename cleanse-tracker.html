<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enlightenment Cleanse Tracker</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #4a7c59;
            --primary-light: #6b9b7a;
            --primary-dark: #3a6249;
            --accent: #f4a261;
            --accent-dark: #e76f51;
            --bg: #f8f6f3;
            --card-bg: #ffffff;
            --text: #2d3436;
            --text-light: #636e72;
            --border: #dfe6e9;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #e17055;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header .phase-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .sync-status {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00b894;
        }

        .sync-dot.syncing {
            background: #fdcb6e;
            animation: pulse 1s infinite;
        }

        .sync-dot.offline {
            background: #e17055;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .nav {
            display: flex;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .nav-btn:hover {
            background: var(--bg);
        }

        .nav-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            text-align: center;
            padding: 1.2rem;
            background: var(--bg);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.3rem;
        }

        .today-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .today-meals, .today-tasks {
            padding: 1rem;
            background: var(--bg);
            border-radius: 10px;
        }

        .today-meals h4, .today-tasks h4 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.8rem;
        }

        .meal-preview {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .meal-preview:last-child {
            border-bottom: none;
        }

        .meal-check {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        /* Meals Styles */
        .day-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .day-btn {
            padding: 0.6rem 1rem;
            border: 2px solid var(--border);
            background: var(--card-bg);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .day-btn:hover {
            border-color: var(--primary-light);
        }

        .day-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .day-btn.completed {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .meal-card {
            border-left: 4px solid var(--primary);
            margin-bottom: 1rem;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .meal-type {
            font-weight: 600;
            font-size: 1rem;
        }

        .meal-calories {
            background: var(--accent);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .meal-name {
            font-size: 1.1rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .meal-ingredients {
            color: var(--text-light);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .meal-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: none;
            border: 2px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Breakfast selector */
        .breakfast-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .breakfast-option {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: var(--card-bg);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .breakfast-option:hover {
            border-color: var(--primary-light);
        }

        .breakfast-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Tasks Styles */
        .task-section {
            margin-bottom: 1.5rem;
        }

        .task-section h3 {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
            padding: 0.8rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: #eef2ee;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            accent-color: var(--primary);
            margin-top: 2px;
        }

        .task-text {
            flex: 1;
            font-size: 0.95rem;
        }

        .task-time {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Progress Styles */
        .progress-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .progress-ring {
            width: 150px;
            height: 150px;
            margin: 0 auto 1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            border-radius: 8px;
            font-size: 0.85rem;
            position: relative;
        }

        .calendar-day.today {
            border: 2px solid var(--primary);
        }

        .calendar-day.completed {
            background: var(--success);
            color: white;
        }

        .calendar-day.partial {
            background: var(--warning);
        }

        .calendar-day.future {
            opacity: 0.5;
        }

        .calendar-day.fast {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .day-label {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-bottom: 0.3rem;
        }

        .week-label {
            grid-column: span 7;
            font-weight: 600;
            padding: 0.5rem;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            text-align: center;
            margin-top: 0.5rem;
        }

        .chart-container {
            height: 200px;
            margin-top: 1rem;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
            padding: 1rem 0;
        }

        .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .bar {
            width: 30px;
            background: linear-gradient(to top, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }

        .bar-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .bar-value {
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        /* Reminders Styles */
        .reminder-list {
            list-style: none;
        }

        .reminder-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .reminder-icon {
            font-size: 1.2rem;
        }

        /* Recipe Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .recipe-section {
            margin-bottom: 1rem;
        }

        .recipe-section h4 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .recipe-section ul {
            margin-left: 1.2rem;
        }

        .recipe-section li {
            margin-bottom: 0.3rem;
            line-height: 1.5;
        }

        /* Notes */
        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .today-info {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .day-selector {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 0.5rem;
            }

            .day-btn {
                flex-shrink: 0;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Water tracker */
        .water-tracker {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .water-glass {
            width: 40px;
            height: 50px;
            border: 2px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            overflow: hidden;
            transition: all 0.2s;
        }

        .water-glass.filled {
            border-color: #3498db;
        }

        .water-glass.filled::before {
            content: '';
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, #3498db, #74b9ff);
            animation: fillUp 0.3s ease;
        }

        @keyframes fillUp {
            from { height: 0; }
            to { height: 100%; }
        }

        /* Settings card */
        .settings-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .settings-section h4 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .user-id-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg);
            padding: 0.8rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .user-id-display input {
            flex: 1;
            border: none;
            background: none;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header class="header" style="position: relative;">
        <h1>Enlightenment Cleanse</h1>
        <div class="phase-badge" id="phaseBadge">Week 1 - Plant-Based Diet</div>
        <div class="sync-status">
            <span class="sync-dot" id="syncDot"></span>
            <span id="syncText">Synced</span>
        </div>
    </header>

    <nav class="nav">
        <button class="nav-btn active" data-tab="dashboard">Dashboard</button>
        <button class="nav-btn" data-tab="meals">Meals</button>
        <button class="nav-btn" data-tab="tasks">Tasks</button>
        <button class="nav-btn" data-tab="progress">Progress</button>
    </nav>

    <main class="container">
        <!-- Dashboard Tab -->
        <section id="dashboard" class="tab-content">
            <div class="card">
                <div class="card-title">üìä Today's Overview</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="dayNumber">1</div>
                        <div class="stat-label">Day of 21</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="caloriesConsumed">0</div>
                        <div class="stat-label">Calories / 2500</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="mealsCompleted">0/3</div>
                        <div class="stat-label">Meals Done</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="tasksCompleted">0</div>
                        <div class="stat-label">Tasks Done</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üíß Water Intake (8 glasses)</div>
                <div class="water-tracker" id="waterTracker">
                    <!-- Generated by JS -->
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìÖ Today - <span id="todayDate"></span></div>
                <div class="today-info">
                    <div class="today-meals">
                        <h4>Today's Meals</h4>
                        <div id="todayMealsList">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                    <div class="today-tasks">
                        <h4>Key Tasks</h4>
                        <div id="todayTasksList">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">‚ö†Ô∏è Daily Reminders</div>
                <ul class="reminder-list">
                    <li class="reminder-item"><span class="reminder-icon">üïó</span> No eating after 8 PM</li>
                    <li class="reminder-item"><span class="reminder-icon">ü•õ</span> Only 1 serving fermented dairy (at dinner)</li>
                    <li class="reminder-item"><span class="reminder-icon">‚òï</span> Max 1 cup green tea</li>
                    <li class="reminder-item"><span class="reminder-icon">üèãÔ∏è</span> Keep up with CrossFit!</li>
                    <li class="reminder-item"><span class="reminder-icon">ü´í</span> Use approved oils only: ghee, olive, coconut, avocado, sesame</li>
                </ul>

                <div class="settings-section">
                    <h4>Sync ID (share to access from other devices)</h4>
                    <div class="user-id-display">
                        <input type="text" id="userIdInput" readonly>
                        <button class="btn btn-small btn-outline" onclick="copyUserId()">Copy</button>
                        <button class="btn btn-small btn-outline" onclick="promptChangeId()">Change</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Meals Tab -->
        <section id="meals" class="tab-content hidden">
            <div class="card">
                <div class="card-title">üìÜ Select Day</div>
                <div class="day-selector" id="daySelector">
                    <!-- Generated by JS -->
                </div>
            </div>

            <div id="mealCards">
                <!-- Generated by JS -->
            </div>

            <div class="card">
                <div class="card-title">üìù Notes for Today</div>
                <textarea class="notes-textarea" id="mealNotes" placeholder="How are you feeling? Any adjustments needed?"></textarea>
            </div>
        </section>

        <!-- Tasks Tab -->
        <section id="tasks" class="tab-content hidden">
            <div class="card">
                <div class="card-title">‚úÖ Daily Tasks</div>
                <div class="task-section">
                    <h3>Morning Routine</h3>
                    <div id="morningTasks">
                        <!-- Generated by JS -->
                    </div>
                </div>
                <div class="task-section">
                    <h3>Throughout the Day</h3>
                    <div id="dailyTasks">
                        <!-- Generated by JS -->
                    </div>
                </div>
                <div class="task-section">
                    <h3>Evening Routine</h3>
                    <div id="eveningTasks">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <div class="card" id="prepTasksCard">
                <div class="card-title">üç≥ Prep Day Tasks (Saturday)</div>
                <div id="prepTasks">
                    <!-- Generated by JS -->
                </div>
            </div>

            <div class="card" id="shoppingCard">
                <div class="card-title">üõí Shopping Tasks</div>
                <div id="shoppingTasks">
                    <!-- Generated by JS -->
                </div>
            </div>
        </section>

        <!-- Progress Tab -->
        <section id="progress" class="tab-content hidden">
            <div class="card">
                <div class="card-title">üéØ Overall Progress</div>
                <div class="progress-header">
                    <svg class="progress-ring" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#dfe6e9" stroke-width="8"/>
                        <circle id="progressCircle" cx="50" cy="50" r="45" fill="none" stroke="#4a7c59" stroke-width="8"
                            stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round"
                            transform="rotate(-90 50 50)"/>
                        <text x="50" y="50" text-anchor="middle" dy="0.3em" font-size="20" font-weight="bold" fill="#4a7c59" id="progressText">0%</text>
                    </svg>
                    <p><strong id="daysCompleted">0</strong> of 21 days completed</p>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìÖ Cleanse Calendar</div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Generated by JS -->
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìà Daily Calories (Last 7 Days)</div>
                <div class="chart-container">
                    <div class="bar-chart" id="calorieChart">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üèÜ Achievements</div>
                <div id="achievements">
                    <!-- Generated by JS -->
                </div>
            </div>
        </section>
    </main>

    <!-- Recipe Modal -->
    <div class="modal-overlay" id="recipeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Recipe</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // FIREBASE CONFIG
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDummyKeyForDemo",
            authDomain: "cleanse-tracker.firebaseapp.com",
            databaseURL: "https://cleanse-tracker-default-rtdb.firebaseio.com",
            projectId: "cleanse-tracker",
            storageBucket: "cleanse-tracker.appspot.com",
            messagingSenderId: "000000000000",
            appId: "1:000000000000:web:0000000000000000000000"
        };

        // Initialize Firebase
        let db = null;
        let userRef = null;
        let isOnline = false;

        function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                isOnline = true;
                setupRealtimeSync();
            } catch (e) {
                console.log('Firebase not available, using local storage only');
                isOnline = false;
                updateSyncStatus('offline');
            }
        }

        function setupRealtimeSync() {
            const userId = getUserId();
            userRef = db.ref('users/' + userId);

            // Listen for changes from other devices
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.lastUpdated !== state.lastUpdated) {
                    state = { ...state, ...data };
                    localStorage.setItem('cleanseTrackerState', JSON.stringify(state));
                    renderCurrentTab();
                    updateSyncStatus('synced');
                }
            });

            // Monitor connection state
            db.ref('.info/connected').on('value', (snap) => {
                isOnline = snap.val() === true;
                updateSyncStatus(isOnline ? 'synced' : 'offline');
            });
        }

        function getUserId() {
            let userId = localStorage.getItem('cleanseUserId');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('cleanseUserId', userId);
            }
            document.getElementById('userIdInput').value = userId;
            return userId;
        }

        function copyUserId() {
            const input = document.getElementById('userIdInput');
            input.select();
            document.execCommand('copy');
            alert('Sync ID copied! Share this to access your data from another device.');
        }

        function promptChangeId() {
            const newId = prompt('Enter your Sync ID (or leave blank to generate new):');
            if (newId !== null) {
                const userId = newId.trim() || 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('cleanseUserId', userId);
                location.reload();
            }
        }

        function updateSyncStatus(status) {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');

            dot.className = 'sync-dot';
            if (status === 'syncing') {
                dot.classList.add('syncing');
                text.textContent = 'Syncing...';
            } else if (status === 'offline') {
                dot.classList.add('offline');
                text.textContent = 'Offline';
            } else {
                text.textContent = 'Synced';
            }
        }

        // =====================================================
        // DATA STRUCTURES
        // =====================================================

        const CLEANSE_START = new Date('2026-01-18');
        const CLEANSE_PHASES = [
            { name: 'Week 1 - Plant-Based Diet', start: '2026-01-18', end: '2026-01-24' },
            { name: 'Week 2 - Continue Diet', start: '2026-01-25', end: '2026-01-29' },
            { name: 'Central Fast (3-5 days)', start: '2026-01-30', end: '2026-02-03' },
            { name: 'Final Phase - Return to Diet', start: '2026-02-04', end: '2026-02-08' }
        ];

        const BREAKFAST_OPTIONS = [
            { id: 'oatmeal', name: 'Fat-Dense Oatmeal Bowl', calories: 850 },
            { id: 'overnight', name: 'Overnight Oats', calories: 850 },
            { id: 'smoothie', name: 'Power Smoothie Bowl', calories: 850 }
        ];

        const MEALS_DATA = {
            'Sun': {
                lunch: { name: 'Buddha Bowl', calories: 850 },
                dinner: { name: 'Lentil Soup + Rice', calories: 800, dairy: true }
            },
            'Mon': {
                lunch: { name: 'Burrito Bowl', calories: 850 },
                dinner: { name: 'Tofu Veggie Stir-Fry', calories: 800, dairy: true }
            },
            'Tue': {
                lunch: { name: 'Chickpea Curry Bowl', calories: 850 },
                dinner: { name: 'Black Bean Buddha Bowl', calories: 800, dairy: true }
            },
            'Wed': {
                lunch: { name: 'Lentil Soup + Quinoa', calories: 850 },
                dinner: { name: 'Tempeh Stir-Fry', calories: 800, dairy: true }
            },
            'Thu': {
                lunch: { name: 'Cauliflower Buddha Bowl', calories: 850 },
                dinner: { name: 'Red Lentil Curry', calories: 800, dairy: true }
            },
            'Fri': {
                lunch: { name: 'Burrito Bowl', calories: 850 },
                dinner: { name: 'Tofu Scramble Bowl', calories: 800, dairy: true }
            },
            'Sat': {
                lunch: { name: 'Chickpea Curry Bowl', calories: 850 },
                dinner: { name: 'Big Buddha Bowl', calories: 800, dairy: true }
            }
        };

        const RECIPES = {
            'Fat-Dense Oatmeal Bowl': {
                prepTime: '5 min',
                cookTime: '5 min',
                ingredients: [
                    '1 cup rolled oats (300 cal)',
                    '2 cups water',
                    '3 Tbsp almond butter (300 cal)',
                    '1 Tbsp ground flaxseed (50 cal)',
                    '1 banana, sliced (100 cal)',
                    '2 Tbsp chopped walnuts (100 cal)',
                    '1/2 tsp cinnamon',
                    '1 tsp maple syrup (optional)'
                ],
                instructions: [
                    'Bring water to boil, add oats, reduce heat and simmer 5 min',
                    'Transfer to bowl, stir in almond butter and flaxseed while hot',
                    'Top with banana, walnuts, cinnamon, maple syrup'
                ]
            },
            'Overnight Oats': {
                prepTime: '5 min (night before)',
                cookTime: 'None - ready to eat!',
                ingredients: [
                    '1 cup rolled oats (300 cal)',
                    '1 cup almond milk or oat milk (60 cal)',
                    '1/2 cup Greek yogurt (optional, or use more milk)',
                    '3 Tbsp almond butter (300 cal)',
                    '1 Tbsp chia seeds (60 cal)',
                    '1 Tbsp ground flaxseed (50 cal)',
                    '1 banana, sliced (100 cal)',
                    '2 Tbsp chopped walnuts (100 cal)',
                    '1/2 tsp cinnamon',
                    '1 tsp maple syrup',
                    '1/2 cup mixed berries (optional topping)'
                ],
                instructions: [
                    'Night before: Combine oats, milk, chia seeds, flaxseed, cinnamon in a jar or container',
                    'Stir in 2 Tbsp almond butter and maple syrup',
                    'Cover and refrigerate overnight (at least 4 hours)',
                    'Morning: Stir well, top with remaining almond butter, banana, walnuts',
                    'Add berries if desired - eat cold or microwave 1-2 min if you prefer warm'
                ]
            },
            'Power Smoothie Bowl': {
                prepTime: '5 min',
                cookTime: 'None',
                ingredients: [
                    '1 cup frozen mixed berries (70 cal)',
                    '1 frozen banana (100 cal)',
                    '1 cup almond milk (60 cal)',
                    '3 Tbsp almond butter (300 cal)',
                    '2 Tbsp ground flaxseed (100 cal)',
                    '1/4 cup rolled oats (75 cal)',
                    '2 Tbsp chopped walnuts (100 cal)',
                    '1 Tbsp chia seeds (60 cal)',
                    'Toppings: sliced banana, berries, coconut flakes'
                ],
                instructions: [
                    'Blend frozen berries, banana, almond milk, 2 Tbsp almond butter, and oats until thick and smooth',
                    'Pour into bowl (should be thick like soft-serve)',
                    'Top with remaining almond butter, flaxseed, walnuts, chia seeds',
                    'Add fresh fruit toppings as desired'
                ]
            },
            'Buddha Bowl': {
                prepTime: '5 min',
                ingredients: [
                    '1.5 cups cooked quinoa (330 cal)',
                    '1 cup cooked chickpeas (210 cal)',
                    '1 cup roasted veggies - sweet potato, broccoli, peppers (80 cal)',
                    '1/2 avocado, sliced (120 cal)',
                    '4 Tbsp tahini dressing (200 cal)',
                    'Handful fresh spinach',
                    'Fresh cilantro, salt'
                ],
                instructions: [
                    'Add quinoa to bowl, microwave 1-2 min if cold',
                    'Top with chickpeas and roasted veggies, microwave 1 min',
                    'Add fresh greens, avocado, drench with tahini',
                    'Top with cilantro'
                ]
            },
            'Burrito Bowl': {
                prepTime: '5 min',
                ingredients: [
                    '1.5 cups cooked brown rice (330 cal)',
                    '1 cup cooked black beans (220 cal)',
                    '1 cup sauteed peppers and onions (50 cal)',
                    '1/2 avocado, diced (120 cal)',
                    '3 Tbsp tahini dressing (150 cal)',
                    '1/4 cup cherry tomatoes, halved',
                    'Fresh cilantro, lime juice, salt',
                    '1/2 tsp cumin, 1/2 tsp chili powder'
                ],
                instructions: [
                    'Heat rice in bowl 1-2 min',
                    'Add black beans (sprinkle with cumin/chili), heat 1 min',
                    'Top with peppers/onions, avocado, tomatoes',
                    'Drizzle tahini, squeeze lime, add cilantro'
                ]
            },
            'Chickpea Curry Bowl': {
                prepTime: '5 min',
                ingredients: [
                    '1.5 cups cooked brown rice (330 cal)',
                    '1.5 cups chickpea curry from prep (350 cal)',
                    '1 cup roasted broccoli or cauliflower (50 cal)',
                    '1 Tbsp ghee, melted on top (120 cal)',
                    'Fresh cilantro'
                ],
                instructions: [
                    'Add rice to bowl, top with chickpea curry',
                    'Microwave 2-3 min until hot',
                    'Add roasted veggies on side',
                    'Drizzle melted ghee, garnish with cilantro'
                ]
            },
            'Lentil Soup + Quinoa': {
                prepTime: '3 min',
                ingredients: [
                    '2 cups lentil soup from prep (300 cal)',
                    '1 cup cooked quinoa (220 cal)',
                    '2 Tbsp olive oil drizzled on top (240 cal)',
                    'Handful of walnuts (100 cal)',
                    'Fresh parsley'
                ],
                instructions: [
                    'Heat soup 2-3 min',
                    'Serve quinoa alongside or stir in',
                    'Drizzle generously with olive oil',
                    'Top with walnuts and parsley'
                ]
            },
            'Cauliflower Buddha Bowl': {
                prepTime: '5 min',
                ingredients: [
                    '1.5 cups cooked quinoa (330 cal)',
                    '1 cup cooked chickpeas (210 cal)',
                    '1 cup roasted cauliflower (50 cal)',
                    '1/2 avocado, sliced (120 cal)',
                    '4 Tbsp tahini dressing (200 cal)',
                    'Handful fresh spinach',
                    'Fresh cilantro, salt'
                ],
                instructions: [
                    'Add quinoa to bowl, microwave 1-2 min if cold',
                    'Top with chickpeas and roasted cauliflower, microwave 1 min',
                    'Add fresh greens, avocado, drench with tahini',
                    'Top with cilantro'
                ]
            },
            'Lentil Soup + Rice': {
                prepTime: '3 min',
                ingredients: [
                    '2 cups lentil soup from prep (300 cal)',
                    '1 cup cooked brown rice (215 cal)',
                    '2 Tbsp olive oil (240 cal)',
                    '1/2 cup yogurt or kefir - daily dairy (50 cal)',
                    'Fresh parsley'
                ],
                instructions: [
                    'Heat soup, serve over or alongside rice',
                    'Drizzle olive oil generously',
                    'Serve yogurt on the side'
                ]
            },
            'Tofu Veggie Stir-Fry': {
                prepTime: '5 min',
                cookTime: '15 min',
                ingredients: [
                    '1 block firm tofu, pressed and cubed (180 cal)',
                    '1.5 cups cooked quinoa (330 cal)',
                    '2 cups mixed vegetables (80 cal)',
                    '3 Tbsp coconut or avocado oil (360 cal)',
                    '2 Tbsp tamari',
                    '1 tsp toasted sesame oil',
                    '2 cloves garlic, minced',
                    '1 tsp fresh ginger, minced',
                    '1/2 cup yogurt - daily dairy (50 cal)'
                ],
                instructions: [
                    'Heat 2 Tbsp oil in large pan over medium-high',
                    'Add tofu cubes, cook 5-7 min until golden',
                    'Remove tofu, add remaining oil',
                    'Add garlic and ginger, stir 30 sec',
                    'Add vegetables, stir-fry 4-5 min',
                    'Return tofu, add tamari, toss',
                    'Serve over quinoa, drizzle sesame oil, yogurt on side'
                ]
            },
            'Black Bean Buddha Bowl': {
                prepTime: '5 min',
                ingredients: [
                    '1 cup cooked quinoa (220 cal)',
                    '1 cup cooked black beans (220 cal)',
                    '1 cup roasted sweet potato (115 cal)',
                    '4 Tbsp tahini dressing (200 cal)',
                    'Handful spinach',
                    '1/2 cup yogurt - daily dairy (50 cal)'
                ],
                instructions: [
                    'Layer quinoa, black beans, sweet potato',
                    'Microwave 2 min',
                    'Add spinach, drench with tahini',
                    'Serve yogurt on side'
                ]
            },
            'Tempeh Stir-Fry': {
                prepTime: '5 min',
                cookTime: '15 min',
                ingredients: [
                    '1 package tempeh, cubed (320 cal)',
                    '1 cup cooked brown rice (215 cal)',
                    '2 cups mixed vegetables (80 cal)',
                    '2 Tbsp coconut oil (240 cal)',
                    '2 Tbsp tamari',
                    '1 Tbsp maple syrup',
                    '1 tsp toasted sesame oil',
                    '2 cloves garlic',
                    '1/2 cup yogurt - daily dairy (50 cal)'
                ],
                instructions: [
                    'Mix tamari and maple syrup for sauce',
                    'Heat coconut oil over medium-high',
                    'Add tempeh, cook 5 min until browned',
                    'Add garlic and vegetables, stir-fry 4-5 min',
                    'Pour sauce over, toss',
                    'Serve over rice, drizzle sesame oil, yogurt on side'
                ]
            },
            'Red Lentil Curry': {
                prepTime: '5 min',
                cookTime: '20 min',
                ingredients: [
                    '1 cup dry red lentils (230 cal cooked)',
                    '1 cup cooked quinoa (220 cal)',
                    '1/2 can coconut milk (200 cal)',
                    '1 Tbsp coconut oil (120 cal)',
                    '1 Tbsp curry powder',
                    '1 can diced tomatoes',
                    '2 cups vegetable broth',
                    '1 onion, diced',
                    '3 cloves garlic, 1 Tbsp ginger',
                    '1/2 cup yogurt (50 cal)'
                ],
                instructions: [
                    'Heat oil, saute onion 3 min',
                    'Add garlic, ginger, curry - stir 1 min',
                    'Add lentils, tomatoes, broth - bring to boil',
                    'Reduce heat, simmer 15 min until soft',
                    'Stir in coconut milk, simmer 2 min',
                    'Serve over quinoa with yogurt'
                ]
            },
            'Tofu Scramble Bowl': {
                prepTime: '5 min',
                cookTime: '10 min',
                ingredients: [
                    '1 block firm tofu, crumbled (180 cal)',
                    '1.5 cups cooked brown rice (330 cal)',
                    '2 cups mixed vegetables (80 cal)',
                    '3 Tbsp coconut or avocado oil (360 cal)',
                    '1/2 tsp turmeric',
                    '2 Tbsp tamari',
                    '2 cloves garlic, minced',
                    '1/2 cup yogurt - daily dairy (50 cal)'
                ],
                instructions: [
                    'Heat oil in large pan over medium-high',
                    'Crumble tofu into pan, add turmeric',
                    'Cook 5 min, stirring to scramble',
                    'Add garlic and vegetables, cook 4-5 min',
                    'Add tamari, toss well',
                    'Serve over brown rice, yogurt on side'
                ]
            },
            'Big Buddha Bowl': {
                prepTime: '5 min',
                ingredients: [
                    '1.5 cups cooked quinoa (330 cal)',
                    '1 cup cooked chickpeas (210 cal)',
                    '1 cup roasted veggies (80 cal)',
                    '1/2 avocado, sliced (120 cal)',
                    '6 Tbsp tahini dressing (300 cal)',
                    'Handful walnuts (100 cal)',
                    'Handful fresh spinach',
                    'Fresh cilantro',
                    '1/2 cup yogurt - daily dairy (50 cal)'
                ],
                instructions: [
                    'Add quinoa to bowl, microwave 1-2 min if cold',
                    'Top with chickpeas and roasted veggies, microwave 1 min',
                    'Add fresh greens, avocado',
                    'Drench with extra tahini, add walnuts',
                    'Top with cilantro, yogurt on side'
                ]
            }
        };

        const DAILY_TASKS = {
            morning: [
                { text: 'Drink glass of water upon waking', time: 'On waking' },
                { text: 'Prepare breakfast', time: '~8:00 AM' },
                { text: 'Take any supplements', time: 'With breakfast' }
            ],
            daily: [
                { text: 'Stay hydrated - 8 glasses of water', time: 'Throughout day' },
                { text: 'Limit caffeine to 1 cup green tea', time: 'Morning only' },
                { text: 'Exercise / CrossFit', time: 'Your usual time' },
                { text: 'Eat lunch', time: '~12:00 PM' },
                { text: 'Mindfulness / meditation', time: 'Afternoon' }
            ],
            evening: [
                { text: 'Prepare dinner with daily dairy portion', time: '~6:00 PM' },
                { text: 'Stop eating by 8 PM', time: 'Before 8:00 PM' },
                { text: 'Light stretching or yoga', time: 'Evening' },
                { text: 'Journal / reflect on the day', time: 'Before bed' }
            ]
        };

        const PREP_TASKS = [
            { text: 'Instant Pot: Chickpeas (35 min)', category: 'Hour 1' },
            { text: 'Instant Pot: Black Beans (25 min)', category: 'Hour 1' },
            { text: 'Instant Pot: Quinoa', category: 'Hour 2' },
            { text: 'Stovetop: Brown Rice', category: 'Hour 2' },
            { text: 'Air Fryer: Sweet Potatoes', category: 'Hour 2' },
            { text: 'Air Fryer: Broccoli & Cauliflower', category: 'Hour 2' },
            { text: 'Air Fryer: Bell Peppers, Zucchini, Onions', category: 'Hour 2' },
            { text: 'Make Tahini Dressing', category: 'Hour 3' },
            { text: 'Make Lentil Soup', category: 'Hour 3' },
            { text: 'Make Chickpea Curry', category: 'Hour 3' },
            { text: 'Prep overnight oats for next few days', category: 'Hour 3' },
            { text: 'Portion everything into containers', category: 'Hour 3' }
        ];

        const SHOPPING_TASKS = {
            'Wed Jan 15': {
                title: 'Order #1 - Pantry Items (Costco & Walmart)',
                items: [
                    'Costco: Quinoa, Brown Rice, Rolled Oats',
                    'Costco: Chickpeas, Black Beans, Lentils',
                    'Costco: Almond Butter, Tahini, Raw Almonds, Walnuts',
                    'Costco: Olive Oil, Coconut Oil, Avocado Oil, Ghee',
                    'Costco: Vegetable Broth, Diced Tomatoes, Coconut Milk',
                    'Costco: Honey, Maple Syrup, Sea Salt',
                    'Costco: Frozen Berries, Frozen Broccoli',
                    'Costco: Chia Seeds (for overnight oats)',
                    'Walmart: Spices (cumin, turmeric, paprika, curry, etc.)',
                    'Walmart: Tamari, Apple Cider Vinegar, Sesame Oil'
                ]
            },
            'Sat Jan 17': {
                title: 'Order #2 - Fresh Items (Costco & Walmart)',
                items: [
                    'Costco: Baby Spinach, Broccoli Florets, Sweet Potatoes',
                    'Costco: Carrots, Bell Peppers, Onions, Garlic, Kale',
                    'Costco: Bananas, Avocados, Lemons, Apples',
                    'Costco: Greek Yogurt or Kefir',
                    'Costco: Almond Milk or Oat Milk (for overnight oats)',
                    'Walmart: Zucchini, Cauliflower, Cilantro, Parsley',
                    'Walmart: Ginger, Cherry Tomatoes, Cucumber',
                    'Walmart: Firm Tofu (4 blocks), Tempeh (2-3 packages)'
                ]
            }
        };

        // =====================================================
        // STATE MANAGEMENT
        // =====================================================

        let state = {
            currentTab: 'dashboard',
            selectedDay: 0,
            meals: {},
            tasks: {},
            prepTasks: {},
            shoppingTasks: {},
            water: {},
            notes: {},
            calories: {},
            breakfastChoices: {}, // { dayIndex: 'oatmeal' | 'overnight' | 'smoothie' }
            lastUpdated: Date.now()
        };

        function loadState() {
            const saved = localStorage.getItem('cleanseTrackerState');
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
            }
        }

        function saveState() {
            state.lastUpdated = Date.now();
            localStorage.setItem('cleanseTrackerState', JSON.stringify(state));

            // Sync to Firebase
            if (userRef && isOnline) {
                updateSyncStatus('syncing');
                userRef.set(state).then(() => {
                    updateSyncStatus('synced');
                }).catch(() => {
                    updateSyncStatus('offline');
                });
            }
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        function getDayOfCleanse(date = new Date()) {
            const start = new Date(CLEANSE_START);
            start.setHours(0, 0, 0, 0);
            const current = new Date(date);
            current.setHours(0, 0, 0, 0);
            const diff = Math.floor((current - start) / (1000 * 60 * 60 * 24));
            return diff;
        }

        function getDateForDay(dayIndex) {
            const date = new Date(CLEANSE_START);
            date.setDate(date.getDate() + dayIndex);
            return date;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        function getDayName(date) {
            return date.toLocaleDateString('en-US', { weekday: 'short' });
        }

        function getCurrentPhase(date = new Date()) {
            for (const phase of CLEANSE_PHASES) {
                const start = new Date(phase.start);
                const end = new Date(phase.end);
                end.setHours(23, 59, 59);
                if (date >= start && date <= end) {
                    return phase.name;
                }
            }
            return 'Pre-Cleanse';
        }

        function isFastingDay(dayIndex) {
            const date = getDateForDay(dayIndex);
            const fastStart = new Date('2026-01-30');
            const fastEnd = new Date('2026-02-03');
            fastEnd.setHours(23, 59, 59);
            return date >= fastStart && date <= fastEnd;
        }

        function getBreakfastForDay(dayIndex) {
            const choice = state.breakfastChoices[dayIndex] || 'oatmeal';
            return BREAKFAST_OPTIONS.find(b => b.id === choice);
        }

        function renderCurrentTab() {
            switch (state.currentTab) {
                case 'dashboard': renderDashboard(); break;
                case 'meals': renderMeals(); break;
                case 'tasks': renderTasks(); break;
                case 'progress': renderProgress(); break;
            }
        }

        // =====================================================
        // RENDER FUNCTIONS
        // =====================================================

        function renderDashboard() {
            const today = new Date();
            const dayIndex = getDayOfCleanse(today);
            const dayNum = Math.max(1, Math.min(21, dayIndex + 1));

            document.getElementById('todayDate').textContent = formatDate(today);
            document.getElementById('dayNumber').textContent = dayNum;
            document.getElementById('phaseBadge').textContent = getCurrentPhase(today);

            // Calculate stats
            const todayMeals = state.meals[dayIndex] || {};
            const mealsCount = [todayMeals.breakfast, todayMeals.lunch, todayMeals.dinner].filter(Boolean).length;
            document.getElementById('mealsCompleted').textContent = `${mealsCount}/3`;

            // Calories
            let calories = 0;
            const dayName = getDayName(today);
            const mealData = MEALS_DATA[dayName];
            const breakfast = getBreakfastForDay(dayIndex);

            if (!isFastingDay(dayIndex)) {
                if (todayMeals.breakfast) calories += breakfast.calories;
                if (mealData) {
                    if (todayMeals.lunch) calories += mealData.lunch.calories;
                    if (todayMeals.dinner) calories += mealData.dinner.calories;
                }
            }
            document.getElementById('caloriesConsumed').textContent = calories;

            // Tasks count
            const todayTasks = state.tasks[dayIndex] || {};
            const completedTasks = Object.values(todayTasks).filter(Boolean).length;
            document.getElementById('tasksCompleted').textContent = completedTasks;

            // Water tracker
            renderWaterTracker(dayIndex);

            // Today's meals preview
            renderTodayMeals(dayIndex, dayName);

            // Today's tasks preview
            renderTodayTasks(dayIndex);
        }

        function renderWaterTracker(dayIndex) {
            const container = document.getElementById('waterTracker');
            const glasses = state.water[dayIndex] || 0;

            container.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const glass = document.createElement('div');
                glass.className = `water-glass ${i < glasses ? 'filled' : ''}`;
                glass.onclick = () => {
                    state.water[dayIndex] = i < glasses ? i : i + 1;
                    saveState();
                    renderWaterTracker(dayIndex);
                };
                container.appendChild(glass);
            }
        }

        function renderTodayMeals(dayIndex, dayName) {
            const container = document.getElementById('todayMealsList');
            const meals = state.meals[dayIndex] || {};
            const mealData = MEALS_DATA[dayName];
            const breakfast = getBreakfastForDay(dayIndex);

            if (isFastingDay(dayIndex)) {
                container.innerHTML = '<p style="color: var(--text-light);">Fasting day - water only</p>';
                return;
            }

            let html = `
                <div class="meal-preview">
                    <input type="checkbox" class="meal-check"
                        ${meals.breakfast ? 'checked' : ''}
                        onchange="toggleMealDashboard(${dayIndex}, 'breakfast')">
                    <span>Breakfast: ${breakfast.name}</span>
                </div>
            `;

            if (mealData) {
                html += `
                    <div class="meal-preview">
                        <input type="checkbox" class="meal-check"
                            ${meals.lunch ? 'checked' : ''}
                            onchange="toggleMealDashboard(${dayIndex}, 'lunch')">
                        <span>Lunch: ${mealData.lunch.name}</span>
                    </div>
                    <div class="meal-preview">
                        <input type="checkbox" class="meal-check"
                            ${meals.dinner ? 'checked' : ''}
                            onchange="toggleMealDashboard(${dayIndex}, 'dinner')">
                        <span>Dinner: ${mealData.dinner.name}</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderTodayTasks(dayIndex) {
            const container = document.getElementById('todayTasksList');
            const tasks = state.tasks[dayIndex] || {};
            const allTasks = [...DAILY_TASKS.morning, ...DAILY_TASKS.daily.slice(0, 2)];

            container.innerHTML = allTasks.slice(0, 4).map((task, i) => `
                <div class="meal-preview">
                    <input type="checkbox" class="meal-check"
                        ${tasks[`task_${i}`] ? 'checked' : ''}
                        onchange="toggleTaskDashboard(${dayIndex}, 'task_${i}')">
                    <span>${task.text}</span>
                </div>
            `).join('');
        }

        function renderMeals() {
            // Day selector
            const selector = document.getElementById('daySelector');
            selector.innerHTML = '';

            for (let i = 0; i < 21; i++) {
                const date = getDateForDay(i);
                const dayMeals = state.meals[i] || {};
                const allDone = dayMeals.breakfast && dayMeals.lunch && dayMeals.dinner;

                const btn = document.createElement('button');
                btn.className = `day-btn ${state.selectedDay === i ? 'active' : ''} ${allDone ? 'completed' : ''}`;
                btn.textContent = `Day ${i + 1}`;
                btn.onclick = () => {
                    state.selectedDay = i;
                    renderMeals();
                };
                selector.appendChild(btn);
            }

            // Meal cards
            const container = document.getElementById('mealCards');
            const date = getDateForDay(state.selectedDay);
            const dayName = getDayName(date);
            const mealData = MEALS_DATA[dayName];
            const meals = state.meals[state.selectedDay] || {};
            const currentBreakfast = getBreakfastForDay(state.selectedDay);

            if (isFastingDay(state.selectedDay)) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-title">üßò Fasting Day</div>
                        <p>This is a fasting day. Stay hydrated with water, herbal tea, and broth if needed.</p>
                    </div>
                `;
                return;
            }

            // Breakfast card with options
            let html = `
                <div class="card meal-card">
                    <div class="meal-header">
                        <span class="meal-type">Breakfast</span>
                        <span class="meal-calories">~${currentBreakfast.calories} cal</span>
                    </div>
                    <div class="breakfast-options">
                        ${BREAKFAST_OPTIONS.map(opt => `
                            <button class="breakfast-option ${(state.breakfastChoices[state.selectedDay] || 'oatmeal') === opt.id ? 'selected' : ''}"
                                onclick="selectBreakfast(${state.selectedDay}, '${opt.id}')">
                                ${opt.name}
                            </button>
                        `).join('')}
                    </div>
                    <div class="meal-name">${currentBreakfast.name}</div>
                    <div class="meal-ingredients">
                        ${RECIPES[currentBreakfast.name] ? RECIPES[currentBreakfast.name].ingredients.slice(0, 4).join(' ‚Ä¢ ') + '...' : ''}
                    </div>
                    <div class="meal-actions">
                        <button class="btn ${meals.breakfast ? 'btn-success' : 'btn-primary'}"
                            onclick="toggleMeal(${state.selectedDay}, 'breakfast')">
                            ${meals.breakfast ? '‚úì Completed' : 'Mark Complete'}
                        </button>
                        <button class="btn btn-outline" onclick="showRecipe('${currentBreakfast.name}')">
                            View Recipe
                        </button>
                    </div>
                </div>
            `;

            // Lunch and dinner cards
            if (mealData) {
                ['lunch', 'dinner'].forEach(type => {
                    const meal = mealData[type];
                    const recipe = RECIPES[meal.name];
                    html += `
                        <div class="card meal-card">
                            <div class="meal-header">
                                <span class="meal-type">${type.charAt(0).toUpperCase() + type.slice(1)}${meal.dairy ? ' ü•õ' : ''}</span>
                                <span class="meal-calories">~${meal.calories} cal</span>
                            </div>
                            <div class="meal-name">${meal.name}</div>
                            <div class="meal-ingredients">
                                ${recipe ? recipe.ingredients.slice(0, 4).join(' ‚Ä¢ ') + '...' : ''}
                            </div>
                            <div class="meal-actions">
                                <button class="btn ${meals[type] ? 'btn-success' : 'btn-primary'}"
                                    onclick="toggleMeal(${state.selectedDay}, '${type}')">
                                    ${meals[type] ? '‚úì Completed' : 'Mark Complete'}
                                </button>
                                <button class="btn btn-outline" onclick="showRecipe('${meal.name}')">
                                    View Recipe
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;

            // Notes
            document.getElementById('mealNotes').value = state.notes[state.selectedDay] || '';
        }

        function renderTasks() {
            const dayIndex = getDayOfCleanse();
            const tasks = state.tasks[dayIndex] || {};
            let taskIndex = 0;

            // Morning tasks
            document.getElementById('morningTasks').innerHTML = DAILY_TASKS.morning.map(task => {
                const id = `task_${taskIndex++}`;
                return createTaskHTML(task, id, tasks[id], dayIndex);
            }).join('');

            // Daily tasks
            document.getElementById('dailyTasks').innerHTML = DAILY_TASKS.daily.map(task => {
                const id = `task_${taskIndex++}`;
                return createTaskHTML(task, id, tasks[id], dayIndex);
            }).join('');

            // Evening tasks
            document.getElementById('eveningTasks').innerHTML = DAILY_TASKS.evening.map(task => {
                const id = `task_${taskIndex++}`;
                return createTaskHTML(task, id, tasks[id], dayIndex);
            }).join('');

            // Prep tasks (show on Saturdays or if incomplete)
            const today = new Date();
            const isSaturday = today.getDay() === 6;
            const prepCard = document.getElementById('prepTasksCard');

            if (isSaturday || Object.keys(state.prepTasks).length > 0) {
                prepCard.classList.remove('hidden');
                document.getElementById('prepTasks').innerHTML = PREP_TASKS.map((task, i) => {
                    const id = `prep_${i}`;
                    return `
                        <div class="task-item ${state.prepTasks[id] ? 'completed' : ''}">
                            <input type="checkbox" class="task-checkbox"
                                ${state.prepTasks[id] ? 'checked' : ''}
                                onchange="togglePrepTask('${id}')">
                            <span class="task-text">${task.text}</span>
                            <span class="task-time">${task.category}</span>
                        </div>
                    `;
                }).join('');
            } else {
                prepCard.classList.add('hidden');
            }

            // Shopping tasks
            renderShoppingTasks();
        }

        function createTaskHTML(task, id, completed, dayIndex) {
            return `
                <div class="task-item ${completed ? 'completed' : ''}">
                    <input type="checkbox" class="task-checkbox"
                        ${completed ? 'checked' : ''}
                        onchange="toggleTask(${dayIndex}, '${id}')">
                    <span class="task-text">${task.text}</span>
                    <span class="task-time">${task.time}</span>
                </div>
            `;
        }

        function renderShoppingTasks() {
            const container = document.getElementById('shoppingTasks');
            const today = new Date();

            let html = '';
            for (const [dateStr, data] of Object.entries(SHOPPING_TASKS)) {
                const itemsHtml = data.items.map((item, i) => {
                    const id = `shop_${dateStr}_${i}`;
                    return `
                        <div class="task-item ${state.shoppingTasks[id] ? 'completed' : ''}">
                            <input type="checkbox" class="task-checkbox"
                                ${state.shoppingTasks[id] ? 'checked' : ''}
                                onchange="toggleShoppingTask('${id}')">
                            <span class="task-text">${item}</span>
                        </div>
                    `;
                }).join('');

                html += `
                    <div class="task-section">
                        <h3>${dateStr} - ${data.title}</h3>
                        ${itemsHtml}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderProgress() {
            const today = new Date();
            const dayIndex = getDayOfCleanse(today);
            const completedDays = countCompletedDays();
            const progress = Math.round((completedDays / 21) * 100);

            // Progress ring
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (progress / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            document.getElementById('progressText').textContent = `${progress}%`;
            document.getElementById('daysCompleted').textContent = completedDays;

            // Calendar
            renderCalendar();

            // Calorie chart
            renderCalorieChart();

            // Achievements
            renderAchievements();
        }

        function countCompletedDays() {
            let count = 0;
            for (let i = 0; i < 21; i++) {
                const meals = state.meals[i] || {};
                if (meals.breakfast && meals.lunch && meals.dinner) count++;
                else if (isFastingDay(i)) count++;
            }
            return count;
        }

        function renderCalendar() {
            const container = document.getElementById('calendarGrid');
            const today = getDayOfCleanse();

            const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = dayLabels.map(d => `<div class="day-label" style="text-align:center;font-weight:500;">${d}</div>`).join('');

            const weeks = [
                { label: 'Week 1 (Jan 18-24)', days: [0, 1, 2, 3, 4, 5, 6] },
                { label: 'Week 2 (Jan 25-29)', days: [7, 8, 9, 10, 11, -1, -1] },
                { label: 'Fast (Jan 30 - Feb 3)', days: [12, 13, 14, 15, 16, -1, -1] },
                { label: 'Final (Feb 4-8)', days: [17, 18, 19, 20, -1, -1, -1] }
            ];

            weeks.forEach(week => {
                html += `<div class="week-label">${week.label}</div>`;
                week.days.forEach(dayIdx => {
                    if (dayIdx === -1) {
                        html += `<div class="calendar-day" style="opacity:0;"></div>`;
                    } else {
                        const date = getDateForDay(dayIdx);
                        const meals = state.meals[dayIdx] || {};
                        const mealsComplete = [meals.breakfast, meals.lunch, meals.dinner].filter(Boolean).length;
                        const isFast = isFastingDay(dayIdx);

                        let classes = 'calendar-day';
                        if (dayIdx === today) classes += ' today';
                        if (dayIdx > today) classes += ' future';
                        if (isFast) classes += ' fast';
                        else if (mealsComplete === 3) classes += ' completed';
                        else if (mealsComplete > 0) classes += ' partial';

                        html += `
                            <div class="${classes}" title="${formatDate(date)}">
                                <span>${date.getDate()}</span>
                            </div>
                        `;
                    }
                });
            });

            container.innerHTML = html;
        }

        function renderCalorieChart() {
            const container = document.getElementById('calorieChart');
            const today = getDayOfCleanse();
            const days = [];

            for (let i = Math.max(0, today - 6); i <= today; i++) {
                const date = getDateForDay(i);
                const dayName = getDayName(date);
                const meals = state.meals[i] || {};
                const mealData = MEALS_DATA[dayName];
                const breakfast = getBreakfastForDay(i);

                let calories = 0;
                if (!isFastingDay(i)) {
                    if (meals.breakfast) calories += breakfast.calories;
                    if (mealData) {
                        if (meals.lunch) calories += mealData.lunch.calories;
                        if (meals.dinner) calories += mealData.dinner.calories;
                    }
                }

                days.push({
                    label: date.toLocaleDateString('en-US', { weekday: 'short' }),
                    value: calories
                });
            }

            const maxCal = 2500;
            container.innerHTML = days.map(d => `
                <div class="bar-wrapper">
                    <div class="bar-value">${d.value}</div>
                    <div class="bar" style="height: ${(d.value / maxCal) * 150}px;"></div>
                    <div class="bar-label">${d.label}</div>
                </div>
            `).join('');
        }

        function renderAchievements() {
            const container = document.getElementById('achievements');
            const completedDays = countCompletedDays();
            const today = getDayOfCleanse();

            const achievements = [
                { icon: 'üå±', name: 'Day 1 Complete', earned: completedDays >= 1 },
                { icon: 'üåø', name: 'First Week Done', earned: completedDays >= 7 },
                { icon: 'üí™', name: 'Halfway There', earned: completedDays >= 11 },
                { icon: 'üßò', name: 'Fast Completed', earned: today >= 16 },
                { icon: 'üèÜ', name: 'Cleanse Master', earned: completedDays >= 21 }
            ];

            container.innerHTML = achievements.map(a => `
                <div class="reminder-item" style="opacity: ${a.earned ? 1 : 0.4}">
                    <span class="reminder-icon">${a.icon}</span>
                    <span>${a.name}</span>
                    ${a.earned ? '<span style="margin-left:auto;color:var(--success);">‚úì</span>' : ''}
                </div>
            `).join('');
        }

        // =====================================================
        // EVENT HANDLERS
        // =====================================================

        function selectBreakfast(dayIndex, breakfastId) {
            state.breakfastChoices[dayIndex] = breakfastId;
            saveState();
            renderMeals();
        }

        function toggleMeal(dayIndex, mealType) {
            if (!state.meals[dayIndex]) state.meals[dayIndex] = {};
            state.meals[dayIndex][mealType] = !state.meals[dayIndex][mealType];
            saveState();
            renderMeals();
            renderDashboard();
        }

        function toggleMealDashboard(dayIndex, mealType) {
            if (!state.meals[dayIndex]) state.meals[dayIndex] = {};
            state.meals[dayIndex][mealType] = !state.meals[dayIndex][mealType];
            saveState();
            renderDashboard();
        }

        function toggleTask(dayIndex, taskId) {
            if (!state.tasks[dayIndex]) state.tasks[dayIndex] = {};
            state.tasks[dayIndex][taskId] = !state.tasks[dayIndex][taskId];
            saveState();
            renderTasks();
            renderDashboard();
        }

        function toggleTaskDashboard(dayIndex, taskId) {
            if (!state.tasks[dayIndex]) state.tasks[dayIndex] = {};
            state.tasks[dayIndex][taskId] = !state.tasks[dayIndex][taskId];
            saveState();
            renderDashboard();
        }

        function togglePrepTask(taskId) {
            state.prepTasks[taskId] = !state.prepTasks[taskId];
            saveState();
            renderTasks();
        }

        function toggleShoppingTask(taskId) {
            state.shoppingTasks[taskId] = !state.shoppingTasks[taskId];
            saveState();
            renderTasks();
        }

        function showRecipe(recipeName) {
            const recipe = RECIPES[recipeName];
            if (!recipe) return;

            document.getElementById('modalTitle').textContent = recipeName;
            document.getElementById('modalContent').innerHTML = `
                <div class="recipe-section">
                    <h4>Time</h4>
                    <p>Prep: ${recipe.prepTime}${recipe.cookTime ? ` | Cook: ${recipe.cookTime}` : ''}</p>
                </div>
                <div class="recipe-section">
                    <h4>Ingredients</h4>
                    <ul>${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}</ul>
                </div>
                <div class="recipe-section">
                    <h4>Instructions</h4>
                    <ol>${recipe.instructions.map(i => `<li>${i}</li>`).join('')}</ol>
                </div>
            `;
            document.getElementById('recipeModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('recipeModal').classList.remove('active');
        }

        // Notes auto-save
        document.getElementById('mealNotes').addEventListener('input', (e) => {
            state.notes[state.selectedDay] = e.target.value;
            saveState();
        });

        // Tab navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                document.getElementById(btn.dataset.tab).classList.remove('hidden');

                state.currentTab = btn.dataset.tab;

                renderCurrentTab();
            });
        });

        // Close modal on overlay click
        document.getElementById('recipeModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('recipeModal')) {
                closeModal();
            }
        });

        // =====================================================
        // INITIALIZATION
        // =====================================================

        function init() {
            loadState();
            getUserId();

            // Set selected day to today if within cleanse period
            const today = getDayOfCleanse();
            if (today >= 0 && today < 21) {
                state.selectedDay = today;
            }

            renderDashboard();

            // Initialize Firebase after local state is loaded
            initFirebase();
        }

        init();
    </script>
</body>
</html>
